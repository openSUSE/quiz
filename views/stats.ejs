<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width" />
    <title>Quiz App</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lato:ital,wght@0,100;0,300;0,400;0,700;0,900;1,100;1,300;1,400;1,700;1,900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Source+Sans+3:wght@400;700&display=swap" rel="stylesheet">
    <link href="/styles.css" rel="stylesheet" type="text/css" />
  </head>
  <body>
    <div class="main-page-container">
      <div class="top-bar-container">
        <div class="user-controls-block">
          <div class="selector-group">
            <div class="refresh-selector-container">
              <label for="refresh-select">‚è±Ô∏è <%= t("Auto Refresh") %>:</label>
              <select id="refresh-select">
                <option value="10000">10s</option>
                <option value="30000" selected>30s</option>
                <option value="60000">60s</option>
                <option value="300000">5min</option>
              </select>
            </div>
            <div class="language-selector-container">
              <label for="lang-select">üåê <%= t("Language") %>:</label>
              <select id="lang-select">
                <% availableLanguages.forEach(function(language) { %>
                  <option value="<%= language.code %>" <%= lang === language.code ? "selected" : "" %>>
                    <%= language.name %>
                  </option>
                <% }); %>
              </select>
            </div>
            <div class="back-link-container"> <!-- Renamed for clarity -->
              <a href="/?lang=<%= lang %>" style="text-decoration:none;">
                <button id="back-btn" class="quiz-btn stats-btn slim-stats-btn"> <!-- Removed back-btn class as it might conflict -->
                  <span class="quiz-btn-title" style="color:white;"><%= t("Back to Main Page") %></span>
                </button>
              </a>
            </div>
          </div>
        </div> <!-- End of user-controls-block -->
      </div>
      <div class="quiz-main-header">
        <div class="opensuse-quiz-logo-header">
          <img src="<%= THEME_IMAGE %>" alt="<%= THEME_TITLE %>" class="opensuse-quiz-logo-header__image">
          <div class="opensuse-quiz-logo-header__text-block">
            <span class="opensuse-quiz-logo-header__text--opensuse"><%= THEME_TITLE %></span>
            <span class="opensuse-quiz-logo-header__text--quiz" style="color:<%= THEME_COLOR %>;">QU1Z!</span>
          </div>
        </div>
        <h2 class="quiz-main-subtitle"><%= t("Leaderboard") %></h2>
      </div>
      <% if (Object.keys(results).length === 0) { %>
        <p><%= t("No users found") %></p>
      <% } else { %>
      <%
        function computeUserStats(data) {
          const WRONG_PENALTY = 0.25;
          let totalCorrect = 0;
          let totalWrong = 0;
          let totalPoints = 0;
          let totalRetakes = 0;

          if (!data.quizzes) return { totalCorrect: 0, wrong: 0, score: 0, retakes: 0 };

          Object.values(data.quizzes).forEach((quiz) => {
            const correct = Number(quiz.correct) || 0;
            const total = Number(quiz.total) || 0;
            const retakes = Number(quiz.retakes) || 0;

            const wrong = Math.max(0, total - correct);

            totalCorrect += correct;
            totalWrong += wrong;
            totalRetakes += retakes;

            const positivePoints = correct;
            const negativePoints = WRONG_PENALTY * wrong;

            // Apply retake penalty only to gained points
            const adjustedPositive = positivePoints * Math.max(0, 1 - retakes * 0.1);

            // minimum is 0, let's make sure we don't destroy score otherwise people would not "gamble"
            const quizPoints = Math.max(0, adjustedPositive - negativePoints);

            totalPoints += quizPoints;
          });

          return { totalCorrect, wrong: totalWrong, score: totalPoints, retakes: totalRetakes };
        }

        // Compute leaderboard
        const leaderboard = Object.entries(results || {}).map(([user, data]) => {
          const s = computeUserStats(data);
          return {
            user,
            totalCorrect: s.totalCorrect,
            wrong: s.wrong,
            score: s.score,
            retakes: s.retakes,
          };
        });

        // Sort by total points descending, then by username
        leaderboard.sort((a, b) => b.score - a.score || a.user.localeCompare(b.user));
      %>
      <table class="results">
        <thead>
        <tr>
          <th><%= t("Nickname") %></th>
          <th><%= t("Correct") %></th>
          <th><%= t("Wrong") %></th>
          <th><%= t("Score") %></th> <!-- New column -->
        </tr>
        </thead>
  <tbody>
  <% leaderboard.forEach(({ user, totalCorrect, wrong, score }) => { %>
    <tr>
      <td style="width: 200px;"><%= user %></td>
      <td style="width: 100px; text-align: center;"><%= totalCorrect %></td>
      <td style="width: 100px; text-align: center;"><%= wrong %></td>
      <td style="width: 100px; text-align: center;"><%= score.toFixed(2) %></td>
    </tr>
  <% }); %>
  </tbody>
</table>
      <% } %>

      <script>
        document.addEventListener("DOMContentLoaded", function () {
          const icons = ["ü•á", "ü•à", "ü•â"];
          const rows = document.querySelectorAll(".results tbody tr");

          rows.forEach((row, index) => {
            if (index < 3) {
              const nameCell = row.querySelector("td:first-child");
              nameCell.innerHTML = `${icons[index]} ${nameCell.innerHTML}`;
            }
          });

          const langSelect = document.getElementById("lang-select");
          langSelect.addEventListener("change", () => {
            const url = new URL(window.location.href);
            url.searchParams.set("lang", langSelect.value);
            window.location.href = url.toString();
          });

          const refreshSelect = document.getElementById("refresh-select");
          refreshSelect.addEventListener("change", () => {
            const url = new URL(window.location.href);
            url.searchParams.set("refresh", refreshSelect.value);
            window.location.href = url.toString();
          });

          const refreshInterval = new URLSearchParams(window.location.search).get("refresh") || 30000;
          if (refreshInterval && !isNaN(parseInt(refreshInterval))) {
            setTimeout(() => {
              window.location.reload();
            }, parseInt(refreshInterval));
          }
        });
      </script>
    </div>
  <footer>
    <p>
      ZWIƒÑZEK STRZELECKI "STRZELEC" ORGANIZACJA SPO≈ÅECZNO - WYCHOWAWCZA JEDNOSTKA STRZELECKA 1011 GRAJEWO 
    </p>
    <p>
      <a href="https://github.com/strzelec-js1011/quiz">üíª Kod ≈∫r√≥d≈Çowy</a> |
      <a href="https://github.com/strzelec-js1011/quiz/blob/main/LICENSE">üìú Licencja</a>
    </p>
  </footer>
  </body>
</html>
